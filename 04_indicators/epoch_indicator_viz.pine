// =============================================================================
// EPOCH INDICATOR VISUALIZATION - Prototype v9
// XIII Trading LLC
// =============================================================================
//
// UNIFIED SINGLE-ZONE design. All information in one clean histogram.
//
// TWO CO-LOCATED HISTOGRAMS + DISPLACEMENT LINE:
//
// 1. CONVICTION BARS (wide, background):
//    Height = directional conviction (delta + SMA + displacement agree)
//    Color  = direction (green shades / red shades / gray / orange)
//
// 2. MOMENTUM BARS (narrow, foreground, overlaid):
//    Height = same as conviction (fills inside the conviction bar)
//    Color  = bright version of conviction color ONLY when momentum is strong
//    → When body is accepting + vol ROC elevated: bright bar fills conviction bar
//    → When body is rejecting or vol weak: momentum bar is shorter/absent
//    → Visual: solid bright bar = everything aligned. Dim outline = conviction
//      without momentum support.
//
// 3. DISPLACEMENT LINE (thin, overlaid):
//    Shows close-to-close movement as a continuous line through the histogram
//    Cyan when bullish, magenta when bearish
//    Flat at zero = price stalled
//    Helps students see "is price actually going anywhere?"
//
// READING:
//    Tall bright green bar with cyan displacement climbing = STRONG LONG
//    Tall dim green bar with flat displacement = WEAK / FADING
//    Short gray bars with flat displacement = ABSORPTION
//    Orange bars with flat displacement = ABSORBING (delta present, no movement)
//
// =============================================================================

//@version=6
indicator("Epoch Indicator Viz", shorttitle="Epoch Viz", overlay=false, precision=1,
     explicit_plot_zorder=true)


// =============================================================================
// INPUTS
// =============================================================================
grp_conv = "Layer 1: Conviction"
vol_delta_roll    = input.int(5, "Vol Delta Rolling Period", minval=1, maxval=20, group=grp_conv)
sma_fast          = input.int(9, "SMA Fast Period", minval=2, maxval=50, group=grp_conv)
sma_slow          = input.int(21, "SMA Slow Period", minval=5, maxval=100, group=grp_conv)
disp_ema          = input.int(5, "Displacement EMA Period", minval=1, maxval=15, group=grp_conv)
disp_threshold    = input.float(0.02, "Displacement Threshold %", minval=0.005, maxval=0.2, step=0.005, group=grp_conv)

grp_mom = "Layer 2: Momentum"
vol_roc_base      = input.int(20, "Vol ROC Baseline Period", minval=5, maxval=50, group=grp_mom)
body_ema          = input.int(3, "Body Ratio EMA Period", minval=1, maxval=10, group=grp_mom)
body_accept_thresh = input.float(0.6, "Body Acceptance Threshold", minval=0.3, maxval=0.9, step=0.05, group=grp_mom)
body_reject_thresh = input.float(0.3, "Body Rejection Threshold", minval=0.1, maxval=0.5, step=0.05, group=grp_mom)

grp_struct = "Structure"
show_structure    = input.bool(true, "Show Structure Table", group=grp_struct)
struct_fractal    = input.int(5, "Fractal Length", minval=2, maxval=10, group=grp_struct)
tf_m5             = input.timeframe("5", "M5 Timeframe", group=grp_struct)
tf_m15            = input.timeframe("15", "M15 Timeframe", group=grp_struct)
tf_h1             = input.timeframe("60", "H1 Timeframe", group=grp_struct)

grp_display = "Display"
norm_period       = input.int(25, "Normalization Period", minval=10, maxval=100, group=grp_display)


// =============================================================================
// COLORS
// =============================================================================
C_BULL            = #26a69a
C_BEAR            = #ef5350
C_NEUTRAL         = #9E9E9E

// Conviction (outer bar) - dimmer
C_CONV_BULL       = #1a5c4a   // Dim green
C_CONV_BEAR       = #5c2a1a   // Dim red
C_CONV_ABSORB     = #2a2a2a   // Dark gray
C_CONV_WARNING    = #664400   // Dim orange

// Momentum (inner bar) - brighter
C_MOM_BULL_HI     = #00E676   // Bright green - strong momentum
C_MOM_BULL_MED    = #26a69a   // Medium green
C_MOM_BEAR_HI     = #FF1744   // Bright red - strong momentum
C_MOM_BEAR_MED    = #ef5350   // Medium red
C_MOM_WARN        = #FF9800   // Orange warning
C_MOM_NONE        = #333333   // No momentum support

// Displacement
C_DISP_BULL       = #00BCD4   // Cyan
C_DISP_BEAR       = #E040FB   // Magenta
C_DISP_FLAT       = #444444

C_HEADER_BG       = #0f3460
C_TABLE_BG        = #1a1a2e


// =============================================================================
// CALCULATIONS (same as v7/v8 - proven logic)
// =============================================================================

// --- Volume Delta ---
bar_range = high - low
bar_position = bar_range != 0 ? (close - low) / bar_range : (close >= open ? 1.0 : 0.0)
delta_multiplier = 2.0 * bar_position - 1.0
bar_delta = volume * delta_multiplier
vol_delta_cumsum = ta.cum(bar_delta)
vol_delta_rolling = bar_index >= vol_delta_roll ? vol_delta_cumsum - vol_delta_cumsum[vol_delta_roll] : vol_delta_cumsum
delta_dir = vol_delta_rolling > 0 ? 1 : vol_delta_rolling < 0 ? -1 : 0
delta_abs = math.abs(vol_delta_rolling)
delta_hi = ta.highest(delta_abs, norm_period)
delta_magnitude = delta_hi > 0 ? delta_abs / delta_hi : 0.0

// --- SMA ---
sma_fast_val = ta.sma(close, sma_fast)
sma_slow_val = ta.sma(close, sma_slow)
sma_spread = sma_fast_val - sma_slow_val
sma_spread_prev = sma_fast_val[1] - sma_slow_val[1]
sma_bullish = sma_fast_val > sma_slow_val
sma_bearish = sma_fast_val < sma_slow_val
sma_expanding = math.abs(sma_spread) > math.abs(sma_spread_prev)
sma_dir = sma_bullish ? 1 : sma_bearish ? -1 : 0

// --- Displacement ---
raw_displacement = close[1] != 0 ? (close - close[1]) / close[1] * 100.0 : 0.0
displacement = ta.ema(raw_displacement, disp_ema)
disp_abs = math.abs(displacement)
disp_hi = ta.highest(disp_abs, norm_period)
disp_norm = disp_hi > 0 ? disp_abs / disp_hi : 0.0
disp_dir = displacement > disp_threshold ? 1 : displacement < -disp_threshold ? -1 : 0
price_is_moving = disp_abs > disp_threshold

// --- Conviction ---
dir_agree_bull = delta_dir == 1 and sma_dir == 1 and disp_dir == 1
dir_agree_bear = delta_dir == -1 and sma_dir == -1 and disp_dir == -1
bull_count = (delta_dir == 1 ? 1 : 0) + (sma_dir == 1 ? 1 : 0) + (disp_dir == 1 ? 1 : 0)
bear_count = (delta_dir == -1 ? 1 : 0) + (sma_dir == -1 ? 1 : 0) + (disp_dir == -1 ? 1 : 0)
partial_bull = bull_count >= 2
partial_bear = bear_count >= 2
is_continuation = dir_agree_bull or dir_agree_bear
is_building = (partial_bull or partial_bear) and not is_continuation
is_absorption = not is_continuation and not is_building
heavy_delta_no_move = delta_magnitude > 0.5 and not price_is_moving
absorb_with_flow = heavy_delta_no_move and (delta_dir != 0)
final_dir = dir_agree_bull or partial_bull ? 1 : dir_agree_bear or partial_bear ? -1 : 0
phase = is_continuation ? 2 : is_building ? 1 : 0

// --- Body Ratio ---
body = math.abs(close - open)
body_ratio_raw = bar_range > 0 ? body / bar_range : 0.5
body_ratio = ta.ema(body_ratio_raw, body_ema)
body_accepting = body_ratio > body_accept_thresh
body_rejecting = body_ratio < body_reject_thresh
body_dir = close > open ? 1 : close < open ? -1 : 0
body_aligned = body_dir == final_dir

// --- Vol ROC ---
baseline_avg = ta.sma(volume[1], vol_roc_base)
vol_roc = baseline_avg != 0 ? ((volume - baseline_avg) / baseline_avg) * 100.0 : 0.0
vol_roc_norm = math.max(0.0, math.min(1.0, (vol_roc + 20.0) / 70.0))

// --- Momentum ---
body_score = body_accepting and body_aligned ? 1.0 : body_accepting ? 0.7 : body_rejecting ? 0.1 : 0.4
momentum = body_score * 0.6 + vol_roc_norm * 0.4


// =============================================================================
// CONVICTION BAR VALUE (outer histogram)
// =============================================================================
conv_base = phase == 2 ? 80.0 : phase == 1 ? 40.0 : 8.0
conv_disp_boost = is_continuation ? disp_norm * 20.0 : 0.0
conviction_val = float(final_dir) * (conv_base + conv_disp_boost)

// Override for absorption with flow (orange bars)
conviction_val := absorb_with_flow ? float(delta_dir) * 30.0 : conviction_val


// =============================================================================
// MOMENTUM BAR VALUE (inner histogram - scales with momentum quality)
// =============================================================================
// Momentum bar is proportional to conviction bar, scaled by momentum score
// When momentum = 1.0, inner bar fills outer completely (solid bright bar)
// When momentum = 0.0, inner bar is zero (dim outline only)
momentum_val = conviction_val * momentum


// =============================================================================
// DISPLACEMENT LINE VALUE (overlaid)
// Maps displacement to roughly -100..+100 for visual co-location with histogram
// =============================================================================
disp_display = disp_hi > 0 ? (displacement / disp_hi) * 80.0 : 0.0
disp_display := math.max(-100.0, math.min(100.0, disp_display))


// =============================================================================
// COLORS
// =============================================================================

// Conviction bar color (dim - the "outline")
conv_color = absorb_with_flow ? C_CONV_WARNING : is_absorption ? C_CONV_ABSORB : final_dir > 0 ? C_CONV_BULL : final_dir < 0 ? C_CONV_BEAR : C_CONV_ABSORB

// Momentum bar color (bright - the "fill")
mom_color = absorb_with_flow ? C_MOM_WARN : is_absorption ? C_MOM_NONE : final_dir > 0 ? (momentum > 0.6 ? C_MOM_BULL_HI : C_MOM_BULL_MED) : final_dir < 0 ? (momentum > 0.6 ? C_MOM_BEAR_HI : C_MOM_BEAR_MED) : C_MOM_NONE

// Displacement line color
disp_color = disp_dir == 1 ? C_DISP_BULL : disp_dir == -1 ? C_DISP_BEAR : C_DISP_FLAT


// =============================================================================
// PLOTTING
// =============================================================================

// Zero + references
hline(0, "Zero", color.new(color.gray, 40), hline.style_solid, 1)
hline(50, "+50", color.new(color.gray, 88), hline.style_dotted, 1)
hline(-50, "-50", color.new(color.gray, 88), hline.style_dotted, 1)
hline(100, "+100", color.new(color.gray, 92), hline.style_dotted, 1)
hline(-100, "-100", color.new(color.gray, 92), hline.style_dotted, 1)

// LAYER 1: Conviction histogram (wide, dim - the "frame")
plot(conviction_val, "Conviction", color=conv_color, linewidth=6, style=plot.style_histogram)

// LAYER 2: Momentum histogram (narrower, bright - the "fill")
plot(momentum_val, "Momentum", color=mom_color, linewidth=3, style=plot.style_histogram)

// LAYER 3: Displacement line (thin, overlaid on everything)
plot(disp_display, "Displacement", color=disp_color, linewidth=2, style=plot.style_line)
// Zero reference for displacement context
plot(0, "Disp Zero", color.new(color.gray, 85), 1, plot.style_line)

// Displacement fill from zero (subtle)
p_disp_line = plot(disp_display, "Disp Fill Edge", color.new(na, 100), display=display.none)
p_zero_ref = plot(0, "Zero Ref", color.new(na, 100), display=display.none)
fill(p_zero_ref, p_disp_line, color=color.new(disp_color, 85), title="Disp Fill")

// Background tint for strong signals
bgcolor(absorb_with_flow ? color.new(C_MOM_WARN, 93) : is_continuation and momentum > 0.5 ? (final_dir > 0 ? color.new(C_MOM_BULL_HI, 94) : color.new(C_MOM_BEAR_HI, 94)) : na, title="Signal BG")


// =============================================================================
// STRUCTURE DETECTION
// =============================================================================
is_fractal_high(len) =>
    result = true
    for i = 1 to len
        if high[len] <= high[len - i] or high[len] <= high[len + i]
            result := false
            break
    result

is_fractal_low(len) =>
    result = true
    for i = 1 to len
        if low[len] >= low[len - i] or low[len] >= low[len + i]
            result := false
            break
    result

var float last_sh_1 = na
var float last_sh_2 = na
var float last_sl_1 = na
var float last_sl_2 = na

fh = is_fractal_high(struct_fractal)
fl = is_fractal_low(struct_fractal)

if fh
    last_sh_2 := last_sh_1
    last_sh_1 := high[struct_fractal]

if fl
    last_sl_2 := last_sl_1
    last_sl_1 := low[struct_fractal]

get_structure() =>
    if na(last_sh_1) or na(last_sh_2) or na(last_sl_1) or na(last_sl_2)
        0
    else
        hh = last_sh_1 > last_sh_2
        hl = last_sl_1 > last_sl_2
        lh = last_sh_1 < last_sh_2
        ll = last_sl_1 < last_sl_2
        if hh and hl
            1
        else if lh and ll
            -1
        else
            0

current_structure = get_structure()
m5_structure  = request.security(syminfo.tickerid, tf_m5,  get_structure())
m15_structure = request.security(syminfo.tickerid, tf_m15, get_structure())
h1_structure  = request.security(syminfo.tickerid, tf_h1,  get_structure())


// =============================================================================
// STRUCTURE TABLE (Left)
// =============================================================================
if show_structure and barstate.islast
    var table structTable = table.new(position.middle_left, 2, 4,
         bgcolor=color.new(C_TABLE_BG, 10), border_width=1, border_color=color.new(color.gray, 60),
         frame_width=1, frame_color=color.new(color.gray, 60))

    table.cell(structTable, 0, 0, "TF", text_color=color.new(color.white, 20),
         text_size=size.small, bgcolor=color.new(C_HEADER_BG, 10))
    table.cell(structTable, 1, 0, "Dir", text_color=color.new(color.white, 20),
         text_size=size.small, bgcolor=color.new(C_HEADER_BG, 10))

    m5_sym = m5_structure == 1 ? "▲" : m5_structure == -1 ? "▼" : "─"
    m5_clr = m5_structure == 1 ? color.new(C_BULL, 0) : m5_structure == -1 ? color.new(C_BEAR, 0) : color.new(C_NEUTRAL, 0)
    table.cell(structTable, 0, 1, "M5", text_color=color.white, text_size=size.small, bgcolor=color.new(C_TABLE_BG, 10))
    table.cell(structTable, 1, 1, m5_sym, text_color=m5_clr, text_size=size.normal, bgcolor=color.new(C_TABLE_BG, 10))

    m15_sym = m15_structure == 1 ? "▲" : m15_structure == -1 ? "▼" : "─"
    m15_clr = m15_structure == 1 ? color.new(C_BULL, 0) : m15_structure == -1 ? color.new(C_BEAR, 0) : color.new(C_NEUTRAL, 0)
    table.cell(structTable, 0, 2, "M15", text_color=color.white, text_size=size.small, bgcolor=color.new(C_TABLE_BG, 10))
    table.cell(structTable, 1, 2, m15_sym, text_color=m15_clr, text_size=size.normal, bgcolor=color.new(C_TABLE_BG, 10))

    h1_sym = h1_structure == 1 ? "▲" : h1_structure == -1 ? "▼" : "─"
    h1_clr = h1_structure == 1 ? color.new(C_BULL, 0) : h1_structure == -1 ? color.new(C_BEAR, 0) : color.new(C_NEUTRAL, 0)
    table.cell(structTable, 0, 3, "H1", text_color=color.white, text_size=size.small, bgcolor=color.new(C_TABLE_BG, 10))
    table.cell(structTable, 1, 3, h1_sym, text_color=h1_clr, text_size=size.normal, bgcolor=color.new(C_TABLE_BG, 10))


// =============================================================================
// INFO TABLE (Top Right) - Clean 2-column
// =============================================================================
if barstate.islast
    var table infoTable = table.new(position.top_right, 2, 8,
         bgcolor=color.new(C_TABLE_BG, 10), border_width=1, border_color=color.new(color.gray, 60))

    // Conviction
    table.cell(infoTable, 0, 0, "CONVICTION", text_color=color.white, text_size=size.tiny, bgcolor=color.new(C_HEADER_BG, 10))
    table.cell(infoTable, 1, 0, "", bgcolor=color.new(C_HEADER_BG, 10), text_size=size.tiny)

    delta_sym = delta_dir == 1 ? "▲" : delta_dir == -1 ? "▼" : "─"
    d_clr = delta_dir == 1 ? color.new(C_BULL, 0) : delta_dir == -1 ? color.new(C_BEAR, 0) : color.new(C_NEUTRAL, 0)
    vd_abs_val = math.abs(vol_delta_rolling)
    vd_str = vd_abs_val >= 1000000 ? str.tostring(vol_delta_rolling / 1000000, "#.#") + "M" : vd_abs_val >= 1000 ? str.tostring(vol_delta_rolling / 1000, "#.#") + "k" : str.tostring(math.round(vol_delta_rolling))
    table.cell(infoTable, 0, 1, "Delta " + delta_sym, text_color=d_clr, text_size=size.tiny)
    table.cell(infoTable, 1, 1, vd_str, text_color=d_clr, text_size=size.tiny)

    sma_sym = sma_dir == 1 ? (sma_expanding ? "▲▲" : "▲") : sma_dir == -1 ? (sma_expanding ? "▼▼" : "▼") : "─"
    s_clr = sma_dir == 1 ? color.new(C_BULL, 0) : sma_dir == -1 ? color.new(C_BEAR, 0) : color.new(C_NEUTRAL, 0)
    table.cell(infoTable, 0, 2, "SMA " + sma_sym, text_color=s_clr, text_size=size.tiny)
    sma_pct_val = close != 0 ? math.abs(sma_spread) / close * 100 : 0.0
    table.cell(infoTable, 1, 2, str.tostring(sma_pct_val, "#.###") + "%", text_color=s_clr, text_size=size.tiny)

    disp_sym = disp_dir == 1 ? "▲" : disp_dir == -1 ? "▼" : "─"
    dp_clr = disp_dir == 1 ? color.new(C_DISP_BULL, 0) : disp_dir == -1 ? color.new(C_DISP_BEAR, 0) : color.new(C_NEUTRAL, 0)
    table.cell(infoTable, 0, 3, "Disp " + disp_sym, text_color=dp_clr, text_size=size.tiny)
    table.cell(infoTable, 1, 3, str.tostring(displacement, "#.####") + "%", text_color=dp_clr, text_size=size.tiny)

    // Momentum
    table.cell(infoTable, 0, 4, "MOMENTUM", text_color=color.white, text_size=size.tiny, bgcolor=color.new(C_HEADER_BG, 10))
    table.cell(infoTable, 1, 4, "", bgcolor=color.new(C_HEADER_BG, 10), text_size=size.tiny)

    body_sym = body_accepting ? (body_aligned ? "◉" : "○") : body_rejecting ? "⊘" : "○"
    b_clr = body_accepting and body_aligned ? color.new(C_MOM_BULL_HI, 0) : body_rejecting ? color.new(C_MOM_WARN, 0) : color.new(C_NEUTRAL, 0)
    table.cell(infoTable, 0, 5, "Body " + body_sym, text_color=b_clr, text_size=size.tiny)
    table.cell(infoTable, 1, 5, str.tostring(body_ratio, "#.##"), text_color=b_clr, text_size=size.tiny)

    vroc_clr = vol_roc > 30 ? color.new(C_MOM_BULL_HI, 0) : vol_roc > 0 ? color.new(C_BULL, 0) : color.new(C_NEUTRAL, 0)
    table.cell(infoTable, 0, 6, "VolROC", text_color=color.white, text_size=size.tiny)
    table.cell(infoTable, 1, 6, str.tostring(vol_roc, "#.#") + "%", text_color=vroc_clr, text_size=size.tiny)

    // Phase
    table.cell(infoTable, 0, 7, "PHASE", text_color=color.white, text_size=size.tiny, bgcolor=color.new(C_HEADER_BG, 10))
    phase_label = absorb_with_flow ? "⚠ ABSORBING" : is_continuation ? "CONTINUATION" : is_building ? "BUILDING" : "ABSORPTION"
    phase_dir_str = final_dir == 1 ? " L" : final_dir == -1 ? " S" : ""
    phase_clr = absorb_with_flow ? color.new(C_MOM_WARN, 0) : is_continuation ? (final_dir > 0 ? color.new(C_MOM_BULL_HI, 0) : color.new(C_MOM_BEAR_HI, 0)) : is_building ? (final_dir > 0 ? color.new(C_BULL, 0) : color.new(C_BEAR, 0)) : color.new(C_NEUTRAL, 0)
    table.cell(infoTable, 1, 7, phase_label + phase_dir_str, text_color=phase_clr, text_size=size.tiny)
